name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - '.github/workflows/pypi-publish.yml'
      - 'python-dsl/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Build test binaries for PR testing
  build-test-binaries:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test binaries
        run: |
          mkdir -p test-binaries

          # Create simple test binaries that output version info
          for suffix in linux-amd64 linux-arm64 darwin-arm64 darwin-amd64 windows-amd64; do
            if [[ "$suffix" == *"windows"* ]]; then
              echo '#!/bin/bash' > test-binaries/pathfinder.exe
              echo 'echo "pathfinder test version (windows)"' >> test-binaries/pathfinder.exe
              echo 'if [ "$1" = "--version" ]; then echo "1.1.3-test"; fi' >> test-binaries/pathfinder.exe
              chmod +x test-binaries/pathfinder.exe
              cd test-binaries && zip pathfinder-${suffix}.zip pathfinder.exe && cd ..
            else
              echo '#!/bin/bash' > test-binaries/pathfinder
              echo 'echo "pathfinder test version ('${suffix}')"' >> test-binaries/pathfinder
              echo 'if [ "$1" = "--version" ]; then echo "1.1.3-test"; fi' >> test-binaries/pathfinder
              chmod +x test-binaries/pathfinder
              cd test-binaries && tar -czf pathfinder-${suffix}.tar.gz pathfinder && cd ..
            fi
          done

          ls -la test-binaries/

      - name: Upload test binaries
        uses: actions/upload-artifact@v4
        with:
          name: test-binaries
          path: test-binaries/*
          retention-days: 1

  # Wait for release workflow to complete and create binaries
  wait-for-binaries:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release artifacts
        run: |
          echo "Waiting for release binaries to be available..."
          echo "Release workflow should complete before this runs"
          sleep 60  # Give release workflow time to upload artifacts

  build-wheels:
    needs: [wait-for-binaries, build-test-binaries]
    if: always() && (needs.wait-for-binaries.result == 'success' || needs.build-test-binaries.result == 'success' || needs.wait-for-binaries.result == 'skipped' || needs.build-test-binaries.result == 'skipped')
    strategy:
      fail-fast: false
      matrix:
        include:
          # Tier 1: Core platforms (~91% coverage)
          - os: ubuntu-latest
            platform: manylinux_2_17_x86_64
            binary_suffix: linux-amd64
            archive_ext: .tar.gz
          - os: ubuntu-latest
            platform: manylinux_2_17_aarch64
            binary_suffix: linux-arm64
            archive_ext: .tar.gz
          - os: macos-latest
            platform: macosx_11_0_arm64
            binary_suffix: darwin-arm64
            archive_ext: .tar.gz
          - os: macos-13
            platform: macosx_10_9_x86_64
            binary_suffix: darwin-amd64
            archive_ext: .tar.gz
          - os: windows-latest
            platform: win_amd64
            binary_suffix: windows-amd64
            archive_ext: .zip

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            # Fallback for workflow_dispatch
            VERSION=$(cat python-dsl/codepathfinder/__init__.py | grep '__version__' | cut -d'"' -f2)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create bin directory
        shell: bash
        run: mkdir -p python-dsl/codepathfinder/bin

      - name: Download test binaries (PR mode)
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: test-binaries
          path: test-binaries

      - name: Extract test binary (PR mode - Unix)
        if: github.event_name == 'pull_request' && runner.os != 'Windows'
        shell: bash
        run: |
          SUFFIX=${{ matrix.binary_suffix }}
          echo "Extracting test binary: pathfinder-${SUFFIX}.tar.gz"
          tar -xzf test-binaries/pathfinder-${SUFFIX}.tar.gz -C python-dsl/codepathfinder/bin/
          chmod +x python-dsl/codepathfinder/bin/pathfinder
          ls -la python-dsl/codepathfinder/bin/

      - name: Extract test binary (PR mode - Windows)
        if: github.event_name == 'pull_request' && runner.os == 'Windows'
        shell: pwsh
        run: |
          $SUFFIX = "${{ matrix.binary_suffix }}"
          Write-Host "Extracting test binary: pathfinder-${SUFFIX}.zip"
          Expand-Archive -Path test-binaries/pathfinder-${SUFFIX}.zip -DestinationPath python-dsl/codepathfinder/bin/
          Get-ChildItem python-dsl/codepathfinder/bin/

      - name: Download binary (Release mode - Unix)
        if: github.event_name != 'pull_request' && runner.os != 'Windows'
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.version }}
          SUFFIX=${{ matrix.binary_suffix }}
          URL="https://github.com/shivasurya/code-pathfinder/releases/download/v${VERSION}/pathfinder-${SUFFIX}.tar.gz"
          echo "Downloading from: $URL"
          curl -L "$URL" | tar xz -C python-dsl/codepathfinder/bin/
          chmod +x python-dsl/codepathfinder/bin/pathfinder
          ls -la python-dsl/codepathfinder/bin/

      - name: Download binary (Release mode - Windows)
        if: github.event_name != 'pull_request' && runner.os == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $URL = "https://github.com/shivasurya/code-pathfinder/releases/download/v$VERSION/pathfinder-windows-amd64.zip"
          Write-Host "Downloading from: $URL"
          Invoke-WebRequest -Uri $URL -OutFile pathfinder.zip
          Expand-Archive -Path pathfinder.zip -DestinationPath python-dsl/codepathfinder/bin/
          Get-ChildItem python-dsl/codepathfinder/bin/

      - name: Install build tools
        run: pip install build wheel setuptools

      - name: Build wheel
        shell: bash
        run: |
          cd python-dsl
          python -m build --wheel

      - name: Rename wheel with platform tag
        shell: bash
        run: |
          cd python-dsl/dist
          for f in *.whl; do
            # Replace 'any' with platform-specific tag
            newname=$(echo "$f" | sed "s/-py3-none-any/-py3-none-${{ matrix.platform }}/")
            if [ "$f" != "$newname" ]; then
              mv "$f" "$newname"
              echo "Renamed: $f -> $newname"
            fi
          done
          ls -la

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: python-dsl/dist/*.whl
          retention-days: 7

  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: pip install build

      - name: Build sdist (no binary - will download on install)
        run: |
          cd python-dsl
          python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: python-dsl/dist/*.tar.gz
          retention-days: 7

  test-wheels:
    needs: build-wheels
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: manylinux_2_17_x86_64
            python-version: '3.11'
          - os: ubuntu-latest
            platform: manylinux_2_17_aarch64
            python-version: '3.11'
          - os: macos-latest
            platform: macosx_11_0_arm64
            python-version: '3.11'
          - os: macos-13
            platform: macosx_10_9_x86_64
            python-version: '3.11'
          - os: windows-latest
            platform: win_amd64
            python-version: '3.11'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: wheel-dist

      - name: Install wheel
        shell: bash
        run: |
          pip install wheel-dist/*.whl
          pip list | grep codepathfinder

      - name: Test CLI is available
        shell: bash
        run: |
          pathfinder --version || echo "pathfinder command not found in PATH"
          which pathfinder || where pathfinder || echo "Binary location unknown"

      - name: Test Python DSL import
        shell: bash
        run: |
          python -c "from codepathfinder import __version__, rule, calls; print(f'DSL OK - Version: {__version__}')"

      - name: Test binary execution
        shell: bash
        run: |
          # Create a test project
          mkdir -p test-project
          echo 'eval("test")' > test-project/test.py

          # Try to run pathfinder
          pathfinder --help || echo "Help command failed"

      - name: Verify binary is bundled
        shell: bash
        run: |
          python -c "from pathlib import Path; import codepathfinder.cli as cli; print(f'Binary path check: {cli.get_binary_path()}')" || echo "Binary check failed"

  publish:
    needs: [build-wheels, build-sdist, test-wheels]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # For trusted publishing

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-temp

      - name: Prepare dist directory
        run: |
          mkdir -p dist
          find dist-temp -name '*.whl' -o -name '*.tar.gz' | xargs -I {} mv {} dist/
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
